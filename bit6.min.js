/* bit6 - v0.9.5 - 2015-10-09 */ (function(){var a=[].slice;window.bit6||(window.bit6={}),bit6.EventEmitter=function(){function b(){this.events={}}return b.prototype.emit=function(){var b,c,d,e,f,g;if(c=arguments[0],b=2<=arguments.length?a.call(arguments,1):[],!this.events[c])return!1;for(g=this.events[c],d=0,e=g.length;e>d;d++)f=g[d],f.apply(null,b);return!0},b.prototype.addListener=function(a,b){var c;return this.emit("newListener",a,b),(null!=(c=this.events)[a]?c[a]:c[a]=[]).push(b),this},b.prototype.on=b.prototype.addListener,b.prototype.once=function(a,b){var c;return c=function(d){return function(){return d.removeListener(a,c),b.apply(null,arguments)}}(this),this.on(a,c),this},b.prototype.removeListener=function(a,b){var c;return this.events[a]?(this.events[a]=function(){var d,e,f,g;for(f=this.events[a],g=[],d=0,e=f.length;e>d;d++)c=f[d],c!==b&&g.push(c);return g}.call(this),this):this},b.prototype.off=b.prototype.removeListener,b.prototype.removeAllListeners=function(a){return delete this.events[a],this},b}()}).call(this),function(){bit6.Conversation=function(){function a(a){this.id=a,this.unread=0,this.updated=0,this.messages=[],this.modified=!0,this.uri=this.id}return a.prototype.getUnreadCount=function(){return this.unread},a.prototype.getLastMessage=function(){var a;return a=this.messages.length,a>0?this.messages[a-1]:null},a.prototype.appendMessage=function(a){return this.messages.push(a),this.updated<a.created&&(this.updated=a.created),this._updateUnreadCount(),this.modified=!0,this.modified},a.prototype.updateMessage=function(a){return this._updateUnreadCount(),this.modified},a.prototype.removeMessage=function(a){var b,c,d,e,f,g,h,i;for(f=this.messages.length,f>0&&this.messages[f-1].id===a.id&&(this.modified=!0),c=-1,h=this.messages,b=d=0,e=h.length;e>d;b=++d)if(g=h[b],g.id===a.id){c=b;break}return c>=0&&(i=this.messages.splice(c,1)),this._updateUnreadCount(),this.modified},a.prototype._updateUnreadCount=function(){var a,b,c,d,e;for(d=0,e=this.messages,a=0,b=e.length;b>a;a++)c=e[a],c.canMarkRead()&&d++;return this.modified||(this.modified=d!==this.unread),this.unread=d},a.prototype.domId=function(){return this.id?this.id.replace(":","--").replace(".","_-").replace("+","-_"):(console.log("ConvId is null",this),null)},a.fromDomId=function(a){return a?a.replace("--",":").replace("_-",".").replace("-_","+"):a},a}()}.call(this),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty;bit6.Dialog=function(b){function c(a,b,d,e){var f;this.client=a,this.outgoing=b,this.other=d,this.options=e,c.__super__.constructor.apply(this,arguments),this.me=this.client.session.identity,this.params={useVideo:this.options.video,useStereo:!1,tag:"webcam",callID:null},f="uid:"+this.client.session.userid+"@"+this.client.apikey,this.outgoing?(this.state="req",this.params.destination_number=this.other+"@"+this.client.apikey,this.params.caller_id_name=this.me,this.params.caller_id_number=f,this.params.callID=bit6.JsonRpc.generateGUID()):(this.state="pre-answer",this.params.callee_id_name=this.me,this.params.callee_id_number=f),this.transfers=[]}return a(c,b),c.prototype.connect=function(a){var b,c,d,e,f;if(null==a&&(a={}),!this.options.audio&&!this.options.video)return this._onMediaReady(),!0;if(this.options.video&&!(a.containerEl||a.localMediaEl&&a.remoteMediaEl))return this.emit("error","Need container or specific video elements"),this.hangup();for(e=["containerEl","localMediaEl","remoteMediaEl"],b=0,d=e.length;d>b;b++)c=e[b],this.options[c]=null!=(f=a[c])?f:null;return console.log("Dialog - calling ensure media",this),this.client._ensureRtcMedia(this.options,1,function(a){return function(b){return console.log("Dialog - media available: ok=",b,"d=",a),b?(a._onMediaReady(),a.options.video?a.emit("videos"):void 0):(a.emit("error","Unable to start media"),a.hangup())}}(this)),!0},c.prototype._onMediaReady=function(){var a;return this.outgoing||this._sendAcceptRejectIncomingCall(!0),this.emit("progress"),this.rtc=this.client._createRtc(),this.rtc.on("offerAnswer",function(a){return function(b){return a._sendOfferAnswer(b,function(c,d){return"answer"===b.type?a.emit("answer"):void 0})}}(this)),this.rtc.on("videos",function(a){return function(){return a.emit("videos")}}(this)),this.rtc.on("dcOpen",function(a){return function(){return a._startNextPendingTransfer()}}(this)),this.rtc.on("transfer",function(a){return function(b){if(a.emit("transfer",b),b.err);else if(b.completed()&&b.outgoing)return a._startNextPendingTransfer()}}(this)),a=this.client.session.config.rtc.iceServers,this.rtc.init(this.client.media,this.outgoing,a,this.options),this.rtc.start()},c.prototype._startNextPendingTransfer=function(){var a,b,c,d,e;for(c=this.transfers,d=[],a=0,b=c.length;b>a;a++){if(e=c[a],e.pending()){this.rtc.startOutgoingTransfer(e);break}d.push(void 0)}return d},c.prototype.sendFile=function(a,b){var c;return c=new bit6.Transfer(!0,a,b),this.transfers.push(c),c._ensureSourceData(function(a){return function(){return null!=c.err&&a.emit("transfer",c),null!=c.data?a.rtc.startOutgoingTransfer(c):void 0}}(this))},c.prototype.hangup=function(){return this.rtc?(this.rtc.stop(),this.rtc=null,this.client._ensureRtcMedia(null,-1),this._sendHangupCall(),this.options.video&&this.emit("videos")):this.outgoing||this._sendAcceptRejectIncomingCall(!1),this.emit("end")},c.prototype._sendOfferAnswer=function(a,b){var c,d,e;return c=a,"offer"===c.type?(this.state="sent-offer",c.dialogParams=this.params,null!=(d=this.client.rpc)?d.call("verto.invite",c,b):void 0):"answer"===c.type?(this.state="sent-answer",this.params.wantVideo=this.options.video,c.dialogParams=this.params,null!=(e=this.client.rpc)?e.call("verto.answer",c,b):void 0):void 0},c.prototype._sendAcceptRejectIncomingCall=function(a){var b;return b=a?"accept":"reject",this.client._sendNotification(this.rdest,b)},c.prototype._sendHangupCall=function(){var a,b;return this.state="sent-bye",a={dialogParams:this.params},null!=(b=this.client.rpc)?b.call("verto.bye",a,function(a){return function(a,b){}}(this)):void 0},c.prototype.handleRpcCall=function(a,b){switch(a){case"verto.bye":return this._gotHangup(b);case"verto.invite":return this.params.callID=b.callID,this.params.caller_id_name=b.caller_id_name,this.params.caller_id_number=b.caller_id_number,this._gotRemoteOfferAnswer("offer",b);case"verto.answer":return this._gotRemoteOfferAnswer("answer",b),this.emit("answer")}},c.prototype._gotRemoteOfferAnswer=function(a,b){return this.state="got-"+a,b.type=a,null!=this.rtc?this.rtc.gotRemoteOfferAnswer(b):console.log("Error: RTC not inited")},c.prototype._gotHangup=function(a){return this.state="got-bye",null!=this.rtc?(this.rtc.stop(),this.rtc=null,this.client._ensureRtcMedia(null,-1),this.options.video&&this.emit("videos"),this.emit("end")):void 0},c}(bit6.EventEmitter)}.call(this),function(){bit6.Group=function(){function a(a){this.id=a,this.meta=null,this.permissions=null,this.members=[],this.updated=0}return a.prototype.update=function(a){var b,c;if(null==a.updated)return!1;if(this.updated===a.updated&&JSON.stringify(this.meta)===JSON.stringify(null!=a?a.meta:void 0)&&JSON.stringify(this.permissions)===JSON.stringify(null!=a?a.permissions:void 0)&&JSON.stringify(this.members)===JSON.stringify(null!=a?a.members:void 0))return!1;for(b in a)c=a[b],this[b]=c;return!0},a.prototype._updateMemberProfile=function(a,b){var c,d,e,f;for(f=this.members,c=0,d=f.length;d>c;c++)if(e=f[c],e.id===a)return e.profile=b,!0;return!1},a}()}.call(this),function(){bit6.JsonRpc=function(){function a(a){var b;this.options=a,null==(b=this.options).sessid&&(b.sessid=bit6.JsonRpc.generateGUID()),this.currentId=1,this.callbacks={},this.queue=[],this.closed=!1}return a.prototype.reconnectDelay=2e3,a.prototype.connect=function(){return this.closed=!1,null==this.ws?(this.ws=new WebSocket(this.options.wsUrl),this.ws.onopen=function(a){return function(){var b,c,d,e;if(a.queue.length>0){for(e=a.queue,b=0,c=e.length;c>b;b++)d=e[b],a.ws.send(d);return a.queue=[]}return a.call("login",{},function(a,b){return console.log("rpc login err=",a,"result=",b)})}}(this),this.ws.onmessage=function(a){return function(b){var c,d,e,f;try{if(f=JSON.parse(b.data),(null!=f.result||null!=f.error)&&null!=f.id&&(c=a.callbacks[f.id],delete a.callbacks[f.id],c(f.error,f.result)),null!=f.method&&null!=f.params)return null!=f.id?a.options.onRpcCall(f.method,f.params,function(b,c){var d;return d={jsonrpc:"2.0",id:f.id},null!=b&&(d.error=b),null!=c&&(d.result=c),a._send(d)}):a.options.onRpcCall(f.method,f.params)}catch(d){return e=d,console.log("Exception parsing JSON response ",e),console.log("  -- RAW {{{",b.data,"}}}")}}}(this),this.ws.onclose=function(a){return function(){return a.closed?void 0:(a.ws=null,a.queue=[],setTimeout(function(){return a.connect()},a.reconnectDelay))}}(this),this.ws.onerror=function(a){return function(){return console.log("Rpc ws got error. Socket state="+a.ws.readyState)}}(this)):void 0},a.prototype.notify=function(a,b){return this.call(a,b,!1)},a.prototype.call=function(a,b,c){var d;return null==this.ws&&this.connect(),d={jsonrpc:"2.0",method:a,params:b},d.params.login=this.options.login,d.params.passwd=this.options.password,null!=this.options.sessid&&(d.params.sessid=this.options.sessid),c!==!1&&(d.id=this.currentId++,this.callbacks[d.id]=c),this._send(d)},a.prototype._send=function(a){var b;return b=JSON.stringify(a),null!=this.ws&&1===this.ws.readyState?this.ws.send(b):this.queue.push(b)},a.prototype.close=function(){return this.closed=!0,null!=this.ws&&this.ws.close(),this.ws=null},a.generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=16*Math.random()|0,c="x"===a?b:3&b|8,c.toString(16)})},a}()}.call(this),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty,c=[].slice;bit6.Client=function(b){function d(a){var b,c;if(d.__super__.constructor.apply(this,arguments),null==(null!=a?a.apikey:void 0))throw'Missing required "apikey" option';this.apikey=a.apikey,this.env=null!=(c=a.env)?c:"prod",b=null!=window.RTCPeerConnection||null!=window.mozRTCPeerConnection||null!=window.webkitRTCPeerConnection,this.caps={audio:b,video:b,websocket:"undefined"!=typeof WebSocket&&null!==WebSocket,attachment:"undefined"!=typeof Blob&&null!==Blob&&"undefined"!=typeof FormData&&null!==FormData&&"undefined"!=typeof FileReader&&null!==FileReader},this._clear(),this.session=new bit6.Session(this)}var e;return a(d,b),d.version="0.9.5",e={prod:"https://api.bit6.com",dev:"https://api.b6dev.net",local:"http://127.0.0.1:3000"},d.prototype._clear=function(){return this.lastSince=0,this.me={},this.messages={},this.conversations={},this.groups={},this.presence={},this.lastTypingSent=0,this.media=null,this.dialogs=[]},d.prototype._onLogin=function(a){return this._connectRt(),this._loadMe(function(b){return function(c){var d,e,f;f=b.groups;for(e in f)d=f[e],d.updated=0,b._loadGroupWithMembers(e);return a(null)}}(this))},d.prototype._onLogout=function(a){return this._disconnectRt(),this._clear(),null!=a?a(null):void 0},d.prototype._loadMe=function(a){var b;return b={embed:"devices,identities,groups,messages",since:this.lastSince},this.api("/me",b,function(b){return function(c,d,e){var f,g,h,i,j;if(c)return a(c);for(console.log("LoadMe got",d,e),b.lastSince=null!=(i=null!=e?e.etag:void 0)?i:0,j=["devices","identities","data","profile"],f=0,h=j.length;h>f;f++)g=j[f],null!=d[g]&&(b.me[g]=d[g]);return null!=d.groups&&b._processGroupInfos(d.groups),b._processMessages(d.messages),a()}}(this))},d.prototype.setPrivateData=function(a,b){return this._setDataOrProfile("data",a,b)},d.prototype.setPublicProfile=function(a,b){return this._setDataOrProfile("profile",a,b)},d.prototype._setDataOrProfile=function(a,b,c){var d,e;return d=null!=(e=this.me[a])?e:null,this.me[a]=b,this.api("/me/"+a,"POST",b,function(b){return function(e,f){return e?(delete b.me[a],d&&(b.me[a]=d)):b.me[a]=f,"function"==typeof c?c(e,f):void 0}}(this))},d.prototype.getConversation=function(a){var b;return null!=(b=this.conversations[a])?b:null},d.prototype.getConversationByUri=function(a){var b;return null!=(b=this.conversations[a])?b:null},d.prototype.getSortedConversations=function(){var a;return a=this.conversations,Object.keys(a).sort(function(b,c){return a[c].updated-a[b].updated}).map(function(b){return a[b]})},d.prototype.addEmptyConversation=function(a){var b,c,d;return c=a,b=null!=(d=this.conversations[c])?d:null,b||(b=new bit6.Conversation(c),this.conversations[c]=b,b.updated=Date.now(),this.emit("conversation",b,1)),b},d.prototype.deleteConversation=function(a,b){var c;return a=(null!=a?a.id:void 0)?a:this.getConversation(a),c=encodeURIComponent(a.id),this.api("/me/messages?other="+c,"DELETE",function(c){return function(d,e){var f,g,h,i;if(d)return"function"==typeof b?b(d):void 0;for(i=a.messages.slice(),f=0,g=i.length;g>f;f++)h=i[f],h.deleted=Date.now(),c._processMessage(h,!0);return delete c.conversations[a.id],a.deleted=Date.now(),c.emit("conversation",a,-1),"function"==typeof b?b(null):void 0}}(this))},d.prototype.markConversationAsRead=function(a){var b,c,d,e,f,g;if(e=0,!(null!=a?a.messages:void 0))return e;for(g=a.messages,b=0,c=g.length;c>b;b++)d=g[b],d.canMarkRead()&&(d.status(bit6.Message.READ),console.log("Msg to be marked: ",d),this._processMessage(d),e++);return 0!==e?(f=encodeURIComponent(a.uri),this.api("/me/messages?other="+f,"PUT",{status:"read"},function(a,b){return console.log("markAsRead result=",b)}),e):void 0},d.prototype.compose=function(a){var b;return b=new bit6.Outgoing(this),null!=a&&b.to(a),b},d.prototype._failOutgoingMessage=function(a){return a.status(bit6.Message.FAILED),this._processMessage(a)},d.prototype._sendMessagePost=function(a,b){var c;return c=a.id,this.api("/me/messages","POST",a._export(),function(d){return function(e,f){var g;return e?(d._failOutgoingMessage(a),"function"==typeof b?b(e):void 0):(console.log("Msg after POST",f),d._processMessage(f),g={id:c,deleted:Date.now()},d._processMessage(g),"function"==typeof b?b(null,d.messages[f.id]):void 0)}}(this))},d.prototype.markMessageAsRead=function(a){return a.canMarkRead()?(a.status(bit6.Message.READ),console.log("Msg to be marked: ",a),this._processMessage(a),this.api("/me/messages/"+a.id,"PUT",{status:"read"},function(a,b){return console.log("markAsRead result=",b)}),!0):!1},d.prototype.deleteMessage=function(a,b){return a=(null!=a?a.id:void 0)?a:this.messages[a],this.api("/me/messages/"+a.id,"DELETE",function(c){return function(d,e){return d?"function"==typeof b?b(d):void 0:(a.deleted=Date.now(),c._processMessage(a),"function"==typeof b?b(null):void 0)}}(this))},d.prototype._processMessages=function(a){var b,c,d,e,f,g,h;if(a){for(c=0,e=a.length;e>c;c++)f=a[c],this._processMessage(f,!0);g=this.conversations,h=[];for(d in g)b=g[d],b.modified?(b.modified=!1,h.push(this.emit("conversation",b,0))):h.push(void 0);return h}},d.prototype._processMessage=function(a,b){var c,d,e,f,g,h,i;if(e=null!=(h=this.messages[a.id])?h:null,g=0,!e){if((null!=a?a.deleted:void 0)>0)return null;e=a instanceof bit6.Message?a:new bit6.Message(a),this.messages[e.id]=e,g=1}return d=e.getConversationId(),c=f=null!=(i=this.conversations[d])?i:null,c||(c=new bit6.Conversation(d),this.conversations[d]=c),g>0?c.appendMessage(e):(e.updateMessage(a),(null!=a?a.deleted:void 0)>0?(delete this.messages[e.id],c.removeMessage(e),g=-1):c.updateMessage(e)),f||(c.modified=!1,this.emit("conversation",c,1)),this.emit("message",e,g),c.modified&&!b&&(c.modified=!1,this.emit("conversation",c,0)),e},d.prototype.getGroup=function(a){var b;return 0===(null!=a?a.indexOf("grp:"):void 0)&&(a=a.substring(4)),null!=(b=this.groups[a])?b:null},d.prototype.getGroupById=function(a){return this.getGroup(a)},d.prototype.createGroup=function(a,b){return null==a&&(a={}),a.identity=this.session.identity,this.api("/groups","POST",a,function(a){return function(c,d){return c?b(c):a._loadMe(function(c){return c?b(c):a._loadGroupWithMembers(d.id,function(c){return c?b(c):b(null,a.getGroup(d.id))})})}}(this))},d.prototype.joinGroup=function(a,b,c){var d,e,f;return d=this.getGroup(a),(null!=d&&null!=(f=d.me)?f.role:void 0)===b?c(null,d):(e={id:this.session.identity,role:b},this.api("/groups/"+a+"/members","POST",e,function(b){return function(d,e){return d?c(d):(console.log("Became group member grpId",a),b._loadMe(function(d){return d?c(d):b._loadGroupWithMembers(a,function(d){return d?c(d):c(null,b.getGroup(a))})}))}}(this)))},d.prototype.leaveGroup=function(a,b){var c;return c=this.getGroup(a),null==c?b(null):(delete this.groups[a],this.emit("group",c,-1),this.api("/groups/"+a+"/members/me","DELETE",function(c){return function(c,d){return c?b(c):(console.log("Left group",a),b(null))}}(this)))},d.prototype._loadGroupWithMembers=function(a,b){return this.api("/groups/"+a,{embed:"members"},function(c){return function(d,e){return console.log("Loaded group",a,"with members: ",e,d),e&&c._processGroupDeltas(e),null!=b?b(d,e):void 0}}(this))},d.prototype._processGroupInfos=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(m=this.groups,this.groups={},c=0,f=a.length;f>c;c++)e=a[c],g={identity:e.identity,role:e.role},h=null!=(j=null!=e?e.group:void 0)?j:{id:e.id},h.me=g,i=0,b=null!=(k=m[h.id])?k:null,null==b?(b=new bit6.Group(h.id),i=1):delete m[h.id],this.groups[b.id]=b,b.update(h)&&this.emit("group",b,i);l=[];for(d in m)b=m[d],l.push(this.emit("group",b,-1));return l},d.prototype._processGroupDeltas=function(a){var b,c;return c=0,b=this.groups[a.id],null==b&&(b=new bit6.Group(a.id),c=1,this.groups[b.id]=b),b.update(a)?this.emit("group",b,c):void 0},d.prototype.sendTypingNotification=function(a){var b;return b=Date.now(),b-this.lastTypingSent>7e3?(this.lastTypingSent=b,this._sendNotification(a,"typing")):void 0},d.prototype.sendNotification=function(a,b,c){return(null!=b?b.length:void 0)<1||"_"===b.charAt(0)?!1:this._sendNotification(a,"_"+b,c)},d.prototype._sendNotification=function(a,b,c){var d,e,f;return e={type:b,from:this.session.identity},null!=c&&(e.data=c),d={to:a,body:JSON.stringify(e)},null!=(f=this.rpc)&&f.call("verto.info",{msg:d},function(a){return function(a,b){}}(this)),!0},d.prototype.startCall=function(a,b){return this._createDialog(!0,a,b)},d.prototype.findDialogByCallID=function(a){var b,c,d,e,f;for(e=this.dialogs,c=0,d=e.length;d>c;c++)if(b=e[c],(null!=(f=b.params)?f.callID:void 0)===a)return b;return null},d.prototype.findDialogByOther=function(a){var b,c,d,e;for(e=this.dialogs,c=0,d=e.length;d>c;c++)if(b=e[c],b.other===a)return b;return null},d.prototype.findDialogByRdest=function(a){var b,c,d,e;for(e=this.dialogs,c=0,d=e.length;d>c;c++)if(b=e[c],b.rdest===a)return b;return null},d.prototype.deleteDialog=function(a){var b,c,d,e,f;for(f=this.dialogs,d=c=0,e=f.length;e>c;d=++c)if(b=f[d],b===a)return void this.dialogs.splice(d,1)},d.prototype._createDialog=function(a,b,c){var d;return d=this.findDialogByOther(b),null!=d?null:(d=new bit6.Dialog(this,a,b,c),this.dialogs.push(d),d.on("error",function(a){return function(){return console.log("Dialog error: ",d)}}(this)),d.on("end",function(a){return function(){return console.log("Dialog end in Main: ",d),a.deleteDialog(d)}}(this)),d)},d.prototype._createDeviceId=function(){return"web-"+bit6.JsonRpc.generateGUID()},d.prototype._createRtc=function(){return new bit6.Rtc},d.prototype._createRtcMedia=function(){return new bit6.RtcMedia},d.prototype._ensureRtcMedia=function(a,b,c){if(!this.media&&b>0&&(this.media=this._createRtcMedia(),this.media.init(a),this.media.start()),this.media)if(this.media.counter+=b,this.media.counter>0){if(null!=c)return this.media.check(c)}else if(this.media.stop(),this.media=null,null!=c)return c(!0)},d.prototype.getNameFromIdentity=function(a){var b,c,d,e,f,g;if(g=a,null==g)return console.log("getNameFromId null",a),null;if(c=a.split(":"),2!==c.length)return g;switch(c[0]){case"usr":g=c[1];break;case"grp":b=this.getGroup(a),g=null!=(d=null!=b&&null!=(e=b.group)&&null!=(f=e.meta)?f.title:void 0)?d:g}return g},d.prototype._handleRtMessage=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;switch(a.type){case"push":return this._handlePushRtMessage(a.data);case"update":if(null!=(null!=(i=a.data)?i.messages:void 0)&&this._processMessages(a.data.messages),(null!=(j=a.data)&&null!=(k=j.groups)?k.length:void 0)>0){for(l=a.data.groups,d=0,e=l.length;e>d;d++)f=l[d],this._loadGroupWithMembers(f.id);return this._loadMe(function(a){return console.log("LoadMe on Group update done",a)})}break;case"presence":if((null!=a?a.from:void 0)&&null!=(null!=a?a.data:void 0)){if(g=this.presence[a.from],this.presence[a.from]=a.data,null==a.data.status&&(this.presence[a.from].status=null!=(m=null!=g?g.status:void 0)?m:"offline"),h=null!=(n=null!=(o=a.data)?o.profile:void 0)?n:null,h&&null!=this.groups){p=this.groups;for(c in p)b=p[c],b._updateMemberProfile(a.from,h)&&this.emit("group",b,0)}return this.emit("notification",a)}break;case"typing":return this.emit("notification",a);default:if((null!=a&&null!=(q=a.type)?q.length:void 0)>1&&"_"===a.type.charAt(0))return a.type=a.type.substring(1),this.emit("notification",a)}},d.prototype._handlePushRtMessage=function(a){var b,c,d,e;switch(d=bit6.Message.typeFromFlags(a.flags)){case bit6.Message.INC_CALL:return c=bit6.Message.channelFromFlags(a.flags),e={audio:(c&bit6.Message.AUDIO)===bit6.Message.AUDIO,video:(c&bit6.Message.VIDEO)===bit6.Message.VIDEO,data:(c&bit6.Message.DATA)===bit6.Message.DATA},b=this._createDialog(!1,a.sender,e),b.rdest=a.rdest,this.emit("incomingCall",b);case bit6.Message.MISSED_CALL:if(console.log("missed call from",a.sender,"rdest=",a.rdest),b=this.findDialogByRdest(a.rdest),null!=b)return b.hangup();break;case bit6.Message.ACCEPTED_CALL:return console.log("accepted call from",a.sender,"rdest=",a.rdest);case bit6.Message.REJECTED_CALL:return console.log("rejected call from",a.sender,"rdest=",a.rdest);case 256:case 512:case 768:case 1024:return this._loadMe(function(a){return console.log("LoadMsgDeltas on push done",a)});default:return console.log("Unknown push: ",a)}},d.prototype._handleRpcNotify=function(a,b){},d.prototype._handleRpcCall=function(a,b,c){var d,e,f,g,h,i;switch(a){case"verto.info":if(null!=(null!=b&&null!=(g=b.msg)?g.body:void 0))try{i=JSON.parse(b.msg.body),this._handleRtMessage(i)}catch(e){f=e,console.log("Exception parsing JSON response verto.info",f),console.log("  -- RAW {{{",b.msg.body,"}}}")}break;case"verto.bye":d=this.findDialogByCallID(b.callID),d&&d.handleRpcCall(a,b);break;case"verto.invite":h=b.caller_id_name,h&&(h=h.split("@")),d=this.findDialogByOther(b.caller_id_name),d&&d.handleRpcCall(a,b);break;case"verto.answer":d=this.findDialogByCallID(b.callID),d&&d.handleRpcCall(a,b)}return c(null,{method:a})},d.prototype._connectRt=function(){var a,b,c,d,e;return e=null!=(b=this.session.config)&&null!=(c=b.rtc)?c.vertoServers:void 0,e.length<1?void console.log("Error: no Verto servers"):(d=e[0],a={wsUrl:d.url,login:d.username,password:d.credential,onRpcCall:function(a){return function(b,c,d){return a._handleRpcCall(b,c,d)}}(this),onRpcNotify:function(a){return function(b,c){return a._handleRpcNotify(b,c)}}(this)},this.rpc=new bit6.JsonRpc(a),this.rpc.connect())},d.prototype._disconnectRt=function(){var a;return null!=(a=this.rpc)&&a.close(),this.rpc=null},d.prototype.api=function(){var a,b,d,e;return e=arguments[0],d=3<=arguments.length?c.call(arguments,1,b=arguments.length-1):(b=1,[]),a=arguments[b++],this._api.apply(this,["/app/1"+e].concat(c.call(d),[a]))},d.prototype._api=function(){var a,b,d,f,g,h,i,j;return h=arguments[0],g=3<=arguments.length?c.call(arguments,1,d=arguments.length-1):(d=1,[]),a=arguments[d++],1===g.length?("string"==typeof g[0]&&(f=g[0]),"object"==typeof g[0]&&(b=g[0])):g.length>=2&&(f=g[0],b=g[1]),null==f&&(f="get"),null==b&&(b={}),f=f.toLowerCase(),i=e[this.env]+h,i+=h.indexOf("?")<0?"?":"&",i+="apikey="+this.apikey,"post"!==f&&(i+="&_method="+f),i+="&envelope=1",this.session.token&&(b._auth="bearer "+this.session.token),j=new XMLHttpRequest,j.open("POST",i,!0),j.setRequestHeader("Content-Type","application/json"),j.onreadystatechange=function(){var b,c,d;if(4===j.readyState){d=null;try{d=JSON.parse(j.response)}catch(b){return c=b,void("function"==typeof a&&a({status:501,message:"Cannot parse response",data:j.response}))}return null==(null!=d?d.status:void 0)?void("function"==typeof a&&a({status:501,message:"Incorrect envelope",data:j.response})):200===j.status&&d.status>=200&&d.status<300?"function"==typeof a?a(null,d.response,d.headers):void 0:"function"==typeof a?a(d.response,null,d.headers):void 0}},j.send(JSON.stringify(b))},d.prototype.urlencodeJsObject=function(a,b){var c,d,e,f;return e=[],e=function(){var e;e=[];for(d in a)f=a[d],c=b?b+"["+d+"]":d,"object"==typeof f?e.push(this.urlencodeJsObject(f,c)):e.push(encodeURIComponent(c)+"="+encodeURIComponent(f));return e}.call(this),e.join("&")},d.normalizeIdentityUri=function(a){var b,c,d,e,f;if(e=a.indexOf(":"),0>e)return null;switch(c=a.substr(0,e),c=c.trim().toLowerCase(),f=a.substr(e+1),b=d=null,c){case"mailto":f=f.toLowerCase(),b=/[^a-z0-9._%+-@]/,d=/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,8}$/;break;case"grp":b=/[\s]/,d=/[0-9a-zA-Z._]{22}/;break;case"tel":b=/[^\\d+]/,d=/^\+[1-9]{1}[0-9]{8,15}$/;break;case"uid":f=f.toLowerCase(),b=/[^0-9a-f-]/,d=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;break;case"usr":f=f.toLowerCase(),b=/[^a-z0-9.]/,d=/^[a-z0-9.]+$/;break;default:b=/[^a-zA-Z0-9._%+-@]/}return b&&(f=f.replace(b,"")),f.search(d)<0?null:c+":"+f},d}(bit6.EventEmitter)}.call(this),function(){bit6.Message=function(){function a(a){this.id=null,this.me=null,this.other=null,this.flags=0,null!=a&&this.populate(a)}var b,c,d,e,f,g;return c=4096,d=15,b=240,e=3840,a.DELETED=0,a.SENDING=1,a.SENT=2,a.FAILED=3,a.DELIVERED=4,a.READ=5,a.ANSWER=1,a.MISSED=2,a.NOANSWER=4,a.SMS=16,a.AUDIO=16,a.VIDEO=128,a.DATA=32,a.TEXT=256,a.ATTACH=512,a.GEOLOC=768,a.CUSTOM=1024,a.CALL=1280,a.INC_CALL=1280,a.MISSED_CALL=1536,g={1:"Sending",2:"Sent",3:"Failed",4:"Delivered",5:"Read"},f={1:"Answered",2:"Missed",3:"Failed",4:"No answer"},a.prototype.populate=function(a){var b,c,d,e,f;for(e=["id","flags","me","other","content","data","created","updated","deleted"],f=[],b=0,d=e.length;d>b;b++)c=e[b],null!=(null!=a?a[c]:void 0)?f.push(this[c]=a[c]):f.push(void 0);return f},a.prototype.updateMessage=function(a){return null!=a.deleted&&(this.deleted=a.deleted),a.flags&&(this.flags=a.flags),null!=a.others?null!=this.others?this._updateMessageOthers(this.others,a.others):this.others=a.others:void 0},a.prototype._updateMessageOthers=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(k=[],e=0,g=b.length;g>e;e++){for(m=b[e],d=-1,c=f=0,h=a.length;h>f;c=++f)if(i=a[c],i.uri===m.uri){d=c;break}0>d?k.push(a.push(m)):(l=null!=(j=a[d])?j.status:void 0,!l||l<m.status?k.push(a[d].status=m.status):k.push(void 0))}return k},a.prototype.incoming=function(){return 0!==(this.flags&c)},a.prototype.status=function(a){return null!=a&&(this.flags=this.flags&~d|a&d),this.flags&d},a.prototype.channel=function(a){return null!=a&&(this.flags=this.flags&~b|a&b),this.flags&b},a.prototype.type=function(a){return null!=a&&(this.flags=this.flags&~e|a&e),this.flags&e},a.prototype.isCall=function(){return(this.flags&e)===a.CALL},a.prototype.canMarkRead=function(){return this.incoming()&&!this.isCall()&&this.status()<bit6.Message.READ},a.prototype.getConversationId=function(){var a;return a=null!=this.me&&0===this.me.indexOf("grp:")?this.me:this.other,a||console.log("msgConvId is null",a),a},a.prototype.getStatusString=function(){var b,c,h;return h=this.flags&e,c=this.flags&d,b=h===a.CALL?f:g,b[c]},a.prototype.domId=function(){return"m"+this.id},a.fromDomId=function(a){return a.length>0&&"m"===a.charAt(0)?a.substring(1):a},a.typeFromFlags=function(a){return a&e},a.channelFromFlags=function(a){return a&b},a.statusFromFlags=function(a){return a&d},a}()}.call(this),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty;bit6.Outgoing=function(b){function c(a){this.client=a,c.__super__.constructor.apply(this,arguments),this.id=bit6.JsonRpc.generateGUID(),this.me=this.client.session.identity,this.created=this.updated=Date.now(),this.flags=bit6.Message.TEXT|bit6.Message.SENDING}return a(c,b),c.prototype._export=function(){var a,b,c,d,e;for(d=["id","flags","me","other","content","data"],e={},a=0,c=d.length;c>a;a++)b=d[a],this[b]&&(e[b]=this[b]);return e},c.prototype.hasAttachment=function(){return null!=this.attachFile},c.prototype.to=function(a){return this.other=a,this},c.prototype.text=function(a){return this.content=a,this},c.prototype.attach=function(a){return this.attachFile=a,this.flags=bit6.Message.ATTACH|this.status(),this.progress=0,this.total=-1,this},c.prototype.send=function(a){return console.log("Sending: ",this),this.hasAttachment()?(this._loadAttachmentAndThumbnail(function(b){return function(c){return b.client._processMessage(b),null!=c?a(c):b._getUploadParams(function(c,d){return console.log("Got upload params",d,"err=",c),null!=c?a(c):b._uploadAttachmentAndThumbnail(d,function(c){return null!=c?a(c):b.client._sendMessagePost(b,a)})})}}(this)),this):(this.client._processMessage(this),this.client._sendMessagePost(this,a))},c.prototype._getUploadParams=function(a){var b,c,d;return null==(null!=(c=this.data)?c.type:void 0)?a("Attachment type is not specified",null):(b={type:this.data.type},b.thumb=null!=(d=this.thumbBlob)?d.type:void 0,this.client.api("/me/messages/attach","post",b,a))},c.prototype._loadAttachmentAndThumbnail=function(a){return bit6.Transfer.readFileAsArrayBuffer(this.attachFile,function(b){return function(c,d,e){return console.log("Read file ",d,"err=",c),null!=c?a(c):b._handleAttachmentFileLoaded(d,e,a)}}(this))},c.prototype._uploadAttachmentAndThumbnail=function(a,b){var c,d,e;return c=this.attachFile,d=0,e=a.uploads.attach,bit6.Outgoing.uploadFile(e.endpoint,e.params,c,function(c){return function(f){return console.log("Main attach uploaded err=",f),null!=f?b(f):(c.data.attach=a.keys.attach,null==c.data.thumb||null==c.thumbBlob?b(null):(e=a.uploads.thumb,bit6.Outgoing.uploadFile(e.endpoint,e.params,c.thumbBlob,function(d){return console.log("Thumb uploaded err=",d),null!=d?b(d):(c.data.thumb=a.keys.thumb,b(null))},function(a,b){return c.progress=a+d,c.total=b+d,c.client.emit("message",c,0)})))}}(this),function(a){return function(b,c){return d=b,a.progress=b,a.total=c,a.client.emit("message",a,0)}}(this))},c.prototype._handleAttachmentFileLoaded=function(a,b,c){var d,e,f,g,h,i,j,k;return k=null!=(i=null!=a?a.type:void 0)?i:"",f=0===k.indexOf("image/"),g=0===k.indexOf("video/"),e=0===k.indexOf("audio/"),f||g?(d=new Blob([b],a),j=(window.URL||window.webkitURL).createObjectURL(d),h=null,f?(h=new Image,h.onload=function(b){return function(){return b._attachmentMediaLoaded(h,a,c)}}(this)):(h=document.createElement("video"),h.setAttribute("preload",""),h.setAttribute("muted",""),h.onloadedmetadata=function(a){return function(){return console.log("Video meta loaded",h.videoWidth,h.videoHeight,h.duration)}}(this),h.onloadeddata=function(b){return function(){return console.log("Video loaded",h),b._attachmentMediaLoaded(h,a,c)}}(this)),h.src=j):e?(this.data={type:a.type},c(null)):c("Cannot handle files with type"+k)},c.prototype._attachmentMediaLoaded=function(a,b,c){return(window.URL||window.webkitURL).revokeObjectURL(a.src),bit6.Outgoing.createThumbnail(a,function(a){return function(d,e){return console.log("Thumb created err=",d),null!=d?c(d):(null!=e&&(a.thumbBlob=bit6.Transfer.dataUrlToBlob(e)),a.data={type:b.type,attach:e,thumb:e},c(null))}}(this))},c.createThumbnail=function(a,b){var c,d,e,f,g,h,i,j,k;return g=320,f=320,k=null!=(h=null!=a?a.videoWidth:void 0)?h:a.width,
j=null!=(i=null!=a?a.videoHeight:void 0)?i:a.height,console.log("Orig media loaded. dimen=",k,j),k>j?k>g&&(j*=g/k,k=g):j>f&&(k*=f/j,j=f),c=document.createElement("canvas"),c.width=k,c.height=j,d=c.getContext("2d"),d.drawImage(a,0,0,k,j),e=c.toDataURL("image/jpeg"),b(null,e)},c.uploadFile=function(a,b,c,d,e){var f;return f=new bit6.Outgoing.UploadDataBuilder(b,c),f.build(function(b,c,f){return null!=b?d(b):bit6.Outgoing._upload(a,c,f,d,e)})},c._upload=function(a,b,c,d,e){var f,g,h;return h=new XMLHttpRequest,h.open("POST",a,!0),h.onload=function(a){return console.log("xhr complete status="+h.status+" "+h.statusText),d(h.status>=200&&h.status<300?null:{status:h.status,text:h.statusText,info:h.responseText})},h.onerror=function(a){return console.log("xhr error",a),d(a)},h.onabort=function(a){return console.log("xhr cancel"),d(a)},h.onprogress=function(a){return console.log("xhr progress",a)},g=null!=(f=null!=h?h.upload:void 0)?f:null,g&&(g.onload=function(a){return console.log("xhr upload complete",a)},g.onerror=function(a){return console.log("xhr upload error",a)},g.onabort=function(a){return console.log("xhr upload cancel",a)},g.onprogress=function(a){var b;return b=a.lengthComputable?a.total:-1,"function"==typeof e?e(a.loaded,b):void 0}),null!=c&&h.setRequestHeader("Content-Type",c),h.send(b)},c}(bit6.Message),bit6.Outgoing.UploadDataBuilder=function(){function a(a,b){return this._needsFormDataShim()?void this._initMultiPart(a,b):this._createFormData(a,b)}return a.prototype._createFormData=function(a,b){var c,d;this.fd=new FormData;for(c in a)d=a[c],this.fd.append(c,d);return this.fd.append("file",b)},a.prototype._initMultiPart=function(a,b){var c,d;this.boundary=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),this.parts=[];for(c in a)d=a[c],this._append(c,d);return b instanceof File?this.fileToLoad=b:this._append("file",b)},a.prototype._append=function(a,b,c){return this.parts.push("--"+this.boundary+'\r\nContent-Disposition: form-data; name="'+a+'"'),b instanceof Blob&&(null==c&&(c="blob"),this.parts.push('; filename="'+c+'"\r\nContent-Type: '+b.type)),this.parts.push("\r\n\r\n"),this.parts.push(b),this.parts.push("\r\n")},a.prototype.build=function(a){return null!=this.fd?a(null,this.fd):this._ensureFileLoaded("file",this.fileToLoad,function(b){return function(c){return c?a(c):b._completeMultiPart(a)}}(this))},a.prototype._ensureFileLoaded=function(a,b,c){return null==b?c(null):bit6.Transfer.readFileAsArrayBuffer(b,function(b){return function(d,e,f){return d?c(d):(b._append(a,new Blob([f],{type:e.type},e.name)),c(null))}}(this))},a.prototype._completeMultiPart=function(a){var b,c;return this.parts.push("--"+this.boundary+"--"),b=new Blob(this.parts),c=new FileReader,c.onload=function(b){return function(){return a(null,c.result,"multipart/form-data; boundary="+b.boundary)}}(this),c.onerror=function(b){return a(b)},c.readAsArrayBuffer(b)},a.prototype._needsFormDataShim=function(){var a,b,c;return b=navigator.userAgent,c=navigator.vendor,a=~b.indexOf("Android")&&~c.indexOf("Google")&&!~b.indexOf("Chrome"),a&&b.match(/AppleWebKit\/(\d+)/).pop()<=534},a}()}.call(this),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty;bit6.RtcMedia=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return a(c,b),c.prototype.init=function(a){return this.options=a,this.preparing=!0,this.ok=!0,this.cbs=[],this.counter=0},c.prototype.start=function(){return this.localStream=null,this.localEl=null,console.log("RtcMedia start",this.options),c.getUserMedia(this.options,function(a){return function(b){return a._handleUserMedia(b),a._done(!0)}}(this),function(a){return function(b){return console.log("getUserMedia error: ",b),a._done(!1)}}(this))},c.prototype.check=function(a){return this.preparing?this.cbs.push(a):a(this.ok)},c.prototype._done=function(a){var b,c,d,e,f;for(this.preparing=!1,this.ok=a,f=this.cbs,this.cbs=[],e=[],c=0,d=f.length;d>c;c++)b=f[c],e.push(b(this.ok));return e},c.prototype.stop=function(){var a,b;return this.localStream&&(this.localStream.stop(),this.localStream=null),this.localEl?(this.localEl.src="",this.options.localMediaEl||null!=(a=this.localEl)&&null!=(b=a.parentNode)&&b.removeChild(this.localEl),this.localEl=null):void 0},c.prototype._handleUserMedia=function(a){var b,d;return this.localStream=a,b=null!=(d=this.options.localMediaEl)?d:null,!b&&this.options.video&&(b=document.createElement("video"),b.setAttribute("class","local"),b.setAttribute("autoplay","true"),b.setAttribute("muted","true"),b.muted=!0,this.options.containerEl.appendChild(b)),this.localEl=b,b?this.localEl=c.attachMediaStream(b,a):void 0},c.getUserMedia=function(a,b,c){return null!=("undefined"!=typeof window&&null!==window?window.getUserMedia:void 0)?window.getUserMedia(a,b,c):null!=("undefined"!=typeof navigator&&null!==navigator?navigator.getUserMedia:void 0)?navigator.getUserMedia(a,b,c):null!=("undefined"!=typeof navigator&&null!==navigator?navigator.mozGetUserMedia:void 0)?navigator.mozGetUserMedia(a,b,c):null!=("undefined"!=typeof navigator&&null!==navigator?navigator.webkitGetUserMedia:void 0)?navigator.webkitGetUserMedia(a,b,c):c("WebRTC not supported. Could not find getUserMedia()")},c.attachMediaStream=function(a,b){return null!=("undefined"!=typeof window&&null!==window?window.attachMediaStream:void 0)?window.attachMediaStream(a,b):(null!=(null!=a?a.srcObject:void 0)?a.srcObject=b:null!=(null!=a?a.mozSrcObject:void 0)?a.mozSrcObject=b:null!=(null!=a?a.src:void 0)?a.src=window.URL.createObjectURL(b):console.log("Error attaching stream to element",a),a)},c}(bit6.EventEmitter)}.call(this),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty;bit6.Rtc=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return a(c,b),c.prototype.init=function(a,b,c,d){return this.media=a,this.outgoing=b,this.options=d,this.pcConstraints={optional:[{DtlsSrtpKeyAgreement:!0}]},this.pcConfig=this._createPcConfig(c),this.isStarted=!1,this.remoteStream=null,this.pc=null,this.outgoingTransfer=null,this.incomingTransfer=null,this.bufferedIceCandidates=[],this.bufferedIceCandidatesDone=!1,this.bufferedOfferAnswer=null},c.prototype.start=function(){return console.log("Rtc start",this.options),this.remoteEl=null,this.outgoing&&this._preparePeerConnection()?(this.options.data&&this._createDataChannel(),this.pc.createOffer(function(a){return function(b){return a._setLocalAndSendOfferAnswer(b)}}(this),function(a){return function(a){return console.log("CreateOffer error",a)}}(this))):void 0},c.prototype.stop=function(){var a,b;return this.isStarted=!1,this.remoteStream&&(this.remoteStream=null),this.remoteEl&&(this.remoteEl.src="",this.options.remoteMediaEl||null!=(a=this.remoteEl)&&null!=(b=a.parentNode)&&b.removeChild(this.remoteEl),this.remoteEl=null),this.dc&&(this.dc.close(),this.dc=null),this.pc?(this.pc.close(),this.pc=null):void 0},c.prototype._preparePeerConnection=function(){var a;return this.isStarted?!1:(this.pc=this._createPeerConnection(),null==this.pc?!1:((null!=(a=this.media)?a.localStream:void 0)&&this.pc.addStream(this.media.localStream),this.isStarted=!0,!0))},c.prototype._createPeerConnection=function(){var a,b,c,d,e,f;try{return a=null!=(e=null!=(f=window.RTCPeerConnection)?f:window.mozRTCPeerConnection)?e:window.webkitRTCPeerConnection,d=new a(this.pcConfig,this.pcConstraints),d.onicecandidate=function(a){return function(b){return a._handleIceCandidate(b)}}(this),d.onaddstream=function(a){return function(b){return a._handleRemoteStreamAdded(b)}}(this),d.onremovestream=function(a){return function(b){return a._handleRemoteStreamRemoved(b)}}(this),d.ondatachannel=function(a){return function(b){return a._createDataChannel(b.channel)}}(this),d}catch(b){return c=b,console.log("Failed to create PeerConnection, exception: ",c),null}},c.prototype._createDataChannel=function(a){var b;return a||(b={ordered:!0},a=this.pc.createDataChannel("mydc",b)),this.dc=a,a.binaryType="arraybuffer",a.onopen=function(a){return function(){return a._handleDcOpen()}}(this),a.onclose=function(a){return function(){return a._handleDcClose()}}(this),a.onerror=function(a){return function(b){return a._handleDcError(b)}}(this),a.onmessage=function(a){return function(b){return a._handleDcMessage(b)}}(this)},c.prototype._handleDcOpen=function(){return console.log("The Data Channel is Opened"),this.emit("dcOpen")},c.prototype._handleDcClose=function(){return console.log("The Data Channel is Closed"),this.outgoingTransfer||this.incomingTransfer?this._handleDcError("DataChannel closed"):void 0},c.prototype._handleDcError=function(a){var b,c,d,e;for(console.log("Data Channel Error:",a),d=[this.outgoingTransfer,this.incomingTransfer],b=0,c=d.length;c>b;b++)e=d[b],e&&(e.err=a),e&&this.emit("transfer",e);return this.outgoingTransfer=this.incomingTransfer=null},c.prototype._handleDcMessage=function(a){var b,c,d;return b=a.data,this.incomingTransfer?null==b.byteLength?console.log("Error: incoming transfer data",b):(c=this.incomingTransfer._gotChunk(b),this.emit("transfer",this.incomingTransfer),c?this.incomingTransfer=null:void 0):null!=b.byteLength?console.log("Error: incoming transfer not created for:",b):(d=JSON.parse(b),d?(this.incomingTransfer=new bit6.Transfer(!1,d),this.emit("transfer",this.incomingTransfer)):console.log("Error: could not parse incoming transfer info:",b))},c.prototype._handleIceCandidate=function(a){var b,c,d;return console.log("handleIceCandidate event: ",a),null!=a.candidate?(c=a.candidate,d=c.sdpMLineIndex,null==(b=this.bufferedIceCandidates)[d]&&(b[d]=[]),this.bufferedIceCandidates[d].push(c)):(console.log("End of candidates."),console.log("BufferedCandidates",this.bufferedIceCandidates),this.bufferedIceCandidatesDone=!0,this._maybeSendOfferAnswer())},c.prototype._maybeSendOfferAnswer=function(){var a;return this.bufferedOfferAnswer&&this.bufferedIceCandidatesDone&&(a=this._mergeSdp(this.bufferedOfferAnswer,this.bufferedIceCandidates),this.bufferedOfferAnswer=null,this.bufferedIceCandidates=[],this.bufferedIceCandidatesDone=!1,console.log("Send OfferAnswer:",a),a)?this.emit("offerAnswer",a):void 0},c.prototype._createPcConfig=function(a){var b;return console.log("RTC createPcConfig got ICE servers:",a),b={iceServers:a}},c.prototype._mergeSdp=function(a,b){var c,d,e,f,g,h,i,j;for(i=a.sdp,d=[],j=0;(e=i.indexOf("m=",j+1))>=0;)d.push(i.substring(j,e)),j=e;for(d.push(i.substring(j)),i="",g=f=0,h=d.length;h>f;g=++f)c=d[g],i+=c,g>0&&null!=b[g-1]&&(i+=this._iceCandidatesToSdp(b[g-1]));return a.sdp=i,a},c.prototype._iceCandidatesToSdp=function(a){var b,c,d,e;for(e="",c=0,d=a.length;d>c;c++)b=a[c],e+="a="+b.candidate+"\r\n";return e},c.prototype._handleRemoteStreamAdded=function(a){var b,c,d;return this.remoteStream=a.stream,b=null!=(c=this.options.remoteMediaEl)?c:null,b||(this.options.video?(b=document.createElement("video"),this.options.containerEl.appendChild(b)):this.options.audio&&(b=document.createElement("audio"),"plugin"===("undefined"!=typeof window&&null!==window?window.webrtcDetectedType:void 0)&&"undefined"!=typeof document&&null!==document&&null!=(d=document.body)&&d.appendChild(b)),b&&(b.setAttribute("class","remote"),b.setAttribute("autoplay","true"))),this.remoteEl=b,b&&(this.remoteEl=bit6.RtcMedia.attachMediaStream(b,a.stream)),this.options.video?this.emit("videos"):void 0},c.prototype._handleRemoteStreamRemoved=function(a){return console.log("Remote stream removed:",a)},c.prototype._setLocalAndSendOfferAnswer=function(a){return this.pc.setLocalDescription(a,function(b){return function(){return b.bufferedOfferAnswer={type:a.type,sdp:a.sdp},b._maybeSendOfferAnswer()}}(this),function(b){return function(b){return console.log("Error setting PeerConnection localDescription",b,a)}}(this))},c.prototype.gotRemoteOfferAnswer=function(a){var b,c;switch(b=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,c=new b(a),a.type){case"offer":return this.outgoing||this.isStarted||this._preparePeerConnection(),this.pc.setRemoteDescription(c),this.pc.createAnswer(function(a){return function(b){return a._setLocalAndSendOfferAnswer(b)}}(this),function(a){return function(a){return console.log("CreateAnswer error",a)}}(this));case"answer":if(this.isStarted)return this.pc.setRemoteDescription(c)}},c.prototype.gotHangup=function(a){return this.stop()},c.prototype.startOutgoingTransfer=function(a){var b,c,d,e,f,g;return this.outgoingTransfer?!1:this.dc?"open"!==this.dc.readyState?!1:(this.outgoingTransfer=a,this.dc.send(JSON.stringify(a.info)),c=a.data,d=10,b=16384,f=0,g=c.byteLength,e=0,e=setInterval(function(d){return function(){var h,i,j;if(h=!1,a=d.outgoingTransfer,(!a||a.err)&&(h=!0),!h){if((null!=(j=d.dc)?j.bufferedAmount:void 0)>50*b)return;i=f+b,i>g&&(i=g),d.dc.send(c.slice(f,i)),f=i,a.progress=f,h=f>=g}return h&&(d.outgoingTransfer=null,clearInterval(e)),a?d.emit("transfer",a):void 0}}(this),d)):!1},c}(bit6.EventEmitter)}.call(this),function(){var a=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a},b={}.hasOwnProperty,c=[].slice;bit6.Session=function(b){function d(a){this.client=a,d.__super__.constructor.apply(this,arguments),this._clear()}return a(d,b),d.prototype._sprops=["authenticated","authInfo","config","device","identity","token","userid"],d.prototype._clear=function(){var a,b,c,d;for(d=this._sprops,a=0,b=d.length;b>a;a++)c=d[a],this[c]=null;return this.authenticated=!1},d.prototype.logout=function(a){return this._clear(),this.client._onLogout(a),this.emit("deauth")},d.prototype.getAuthInfo=function(a){return this.authInfo?a(null,this.authInfo):this.api("/info",function(b){return function(c,d){return c?a(c):(b.authInfo=d,a(c,d))}}(this))},d.prototype.login=function(a,b){return a.identity=bit6.Client.normalizeIdentityUri(a.identity),this._auth("login",a,b)},d.prototype.signup=function(a,b){return a.identity=bit6.Client.normalizeIdentityUri(a.identity),this._auth("signup",a,b)},d.prototype.anonymous=function(a){return this._auth("anonymous",{},a)},d.prototype.oauth=function(a,b,c){return this._ensureOauthRedirectUri(b),this.getAuthInfo(function(d){return function(e,f){return e?c(e):d._auth(a,b,c)}}(this))},d.prototype.oauth1_redirect=function(a,b,c){return this._ensureOauthRedirectUri(b),this.api("/"+a,"POST",b,c)},d.prototype._ensureOauthRedirectUri=function(a){var b,c,d,e;return b=null!=(c=a.redirect_uri)?c:a.redirectUri,null==b?a.redirect_uri="undefined"!=typeof window&&null!==window&&null!=(d=window.location)&&null!=(e=d.href)?e.split("?")[0]:void 0:void 0},d.prototype.refresh=function(a){return this._auth("refresh_token",{},a)},d.prototype.save=function(){var a,b,c,d,e;for(e={},d=this._sprops,a=0,b=d.length;b>a;a++)c=d[a],e[c]=this[c];return e},d.prototype.resume=function(a,b){var c,d,e,f,g;for(f=this._sprops,c=0,d=f.length;d>c;c++)e=f[c],this[e]=null!=(g=null!=a?a[e]:void 0)?g:null;return this.refresh(b)},d.prototype._auth=function(a,b,c){return null==b&&(b={}),null==this.device&&(this.device=this.client._createDeviceId()),b.device=this.device,b.embed="config",this.api("/"+a,"POST",b,function(a){return function(b,d){var e,f,g,h;if(b){for(h=["config","identity","token","userid"],e=0,g=h.length;g>e;e++)f=h[e],delete a[f];return c(b)}return a._authDone(d,c)}}(this))},d.prototype._authDone=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==a.token)return b("Jwt token is missing");try{k=a.token.split("."),e=null!=k?k[1]:void 0,null!=e&&(d=JSON.parse(bit6.Session.base64urlDecode(e))),console.log("Jwt claims",d)}catch(f){g=f,console.log("Error parsing Jwt claims",k[1])}if(p=null!=d&&null!=(l=d.sub)?l.split("@"):void 0,null!=p&&2===p.length&&(o=p[0],c=p[1]),null==o||null==c)return b("Jwt token has invalid format");for(this.authenticated=!0,m=["config","identity","token","userid"],h=0,j=m.length;j>h;h++)i=m[h],this[i]=null!=(n=a[i])?n:this[i];return this.client._onLogin(b),this.emit("auth")},d.prototype.api=function(){var a,b,d,e,f;return e=arguments[0],d=3<=arguments.length?c.call(arguments,1,b=arguments.length-1):(b=1,[]),a=arguments[b++],(f=this.client)._api.apply(f,["/auth/1"+e].concat(c.call(d),[a]))},d.base64urlDecode=function(a){return a+=new Array(4-(a.length+3&3)).join("="),a=a.replace(/\-/g,"+").replace(/_/g,"/"),a=atob(a)},d}(bit6.EventEmitter)}.call(this),function(){bit6.Transfer=function(){function a(a,b,c){var d;this.outgoing=a,this.info=b,this.progress=0,this.total=null!=(d=this.info.size)?d:0,this.err=null,this.data=null!=c?c:null,this.outgoing||(this.buf=[])}return a.prototype.pending=function(){return this.outgoing&&this.data&&!this.err&&0===this.progress},a.prototype.completed=function(){return this.progress===this.total&&this.data&&!this.err},a.prototype.percentage=function(){return this.total?(100*this.progress/this.total).toFixed(2):0},a.prototype._ensureSourceData=function(a){return null!=this.data?a(null):bit6.Transfer.readFileAsArrayBuffer(this.info,function(b){return function(c,d,e){return null!=c&&(b.err=c),null!=e&&null!=d&&(b.info=d),null!=e&&(b.data=e),a(c)}}(this))},a.prototype._gotChunk=function(a){return this.buf.push(a),this.progress+=a.byteLength,this.progress<this.total?!1:(this._prepareReceivedData(),!0)},a.prototype._prepareReceivedData=function(){var a,b,c,d,e,f;for(f=new Uint8Array(this.progress),d=0,e=this.buf,b=0,c=e.length;c>b;b++)a=e[b],f.set(new Uint8Array(a),d),d+=a.byteLength;return this.buf=null,this.data=f.buffer},a.readFileAsArrayBuffer=function(a,b){var c;return c=new FileReader,c.onload=function(d){var e,f;return c.readyState===FileReader.DONE?(e=d.target.result,console.log(a.name+" - read "+e.byteLength+"b"),f={name:a.name,type:a.type,size:a.size},b(null,f,e)):void 0},c.onerror=function(a){return b(a)},c.onabort=function(a){return b(a)},c.readAsArrayBuffer(a)},a.dataUrlToBlob=function(a){var b,c,d,e,f,g,h,i,j,k;if(g=";base64,",i=null,d=null,a.indexOf(g)<0)h=a.split(","),d=h[0].split(":")[1],i=decodeURIComponent(h[1]);else{for(h=a.split(g),d=h[0].split(":")[1],i=atob(h[1]),j=i.length,b=new ArrayBuffer(j),c=new Uint8Array(b),e=f=0,k=j-1;k>=0?k>f:f>k;e=k>=0?++f:--f)c[e]=i.charCodeAt(e);i=b}return new Blob([i],{type:d})},a}()}.call(this);