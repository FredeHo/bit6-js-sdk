/* bit6 - v0.8.5 - 2015-02-26 */ function trace(a){"\n"==a[a.length-1]&&(a=a.substring(0,a.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+a)}function maybeFixConfiguration(a){if(null!=a)for(var b=0;b<a.iceServers.length;b++)a.iceServers[b].hasOwnProperty("urls")&&(a.iceServers[b].url=a.iceServers[b].urls,delete a.iceServers[b].urls)}(function(){var a=[].slice;window.bit6||(window.bit6={}),bit6.EventEmitter=function(){function b(){this.events={}}return b.prototype.emit=function(){var b,c,d,e,f,g;if(c=arguments[0],b=2<=arguments.length?a.call(arguments,1):[],!this.events[c])return!1;for(g=this.events[c],e=0,f=g.length;f>e;e++)d=g[e],d.apply(null,b);return!0},b.prototype.addListener=function(a,b){var c;return this.emit("newListener",a,b),(null!=(c=this.events)[a]?c[a]:c[a]=[]).push(b),this},b.prototype.on=b.prototype.addListener,b.prototype.once=function(a,b){var c;return c=function(d){return function(){return d.removeListener(a,c),b.apply(null,arguments)}}(this),this.on(a,c),this},b.prototype.removeListener=function(a,b){var c;return this.events[a]?(this.events[a]=function(){var d,e,f,g;for(f=this.events[a],g=[],d=0,e=f.length;e>d;d++)c=f[d],c!==b&&g.push(c);return g}.call(this),this):this},b.prototype.off=b.prototype.removeListener,b.prototype.removeAllListeners=function(a){return delete this.events[a],this},b}()}).call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};window.bit6||(window.bit6={}),bit6.Dialog=function(a){function c(a,b,d,e){var f;this.client=a,this.outgoing=b,this.other=d,this.options=e,c.__super__.constructor.apply(this,arguments),this.me=this.client.session.identity,this.params={useVideo:this.options.video,useStereo:!1,tag:"webcam",callID:null},f="uid:"+this.client.session.userid+"@"+this.client.apikey,this.outgoing?(this.state="req",this.params.destination_number=this.other+"@"+this.client.apikey,this.params.caller_id_name=this.me,this.params.caller_id_number=f,this.params.callID=bit6.JsonRpc.generateGUID()):(this.state="pre-answer",this.params.callee_id_name=this.me,this.params.callee_id_number=f)}return b(c,a),c.prototype.connect=function(a){return null!=(null!=a?a.localMediaEl:void 0)&&(this.options.localMediaEl=a.localMediaEl),null!=(null!=a?a.remoteMediaEl:void 0)&&(this.options.remoteMediaEl=a.remoteMediaEl),this.rtc=new bit6.Rtc(this),this.rtc.on("offerAnswer",function(a){return function(b){return a._sendOfferAnswer(b,function(){return"answer"===b.type?a.emit("answer"):void 0})}}(this)),this.options.iceServers=this.client.session.config.rtc.iceServers,this.rtc.start(this.options,function(a){return function(b){return b?(a.outgoing||a._sendAcceptRejectIncomingCall(!0),a.emit("progress")):(a.emit("error","Unable to start media"),a.hangup())}}(this))},c.prototype.hangup=function(){return this.params.callID?(this.rtc.stop(),this.rtc=null,this._sendHangupCall()):this.outgoing||this._sendAcceptRejectIncomingCall(!1),this.emit("end")},c.prototype._sendOfferAnswer=function(a,b){var c;return c=a,"offer"===c.type?(this.state="sent-offer",c.dialogParams=this.params,this.client.rpc.call("verto.invite",c,b)):"answer"===c.type?(this.state="sent-answer",this.params.wantVideo=this.options.video,c.dialogParams=this.params,this.client.rpc.call("verto.answer",c,b)):void 0},c.prototype._sendAcceptRejectIncomingCall=function(a){var b;return b=a?"accept":"reject",this.client._sendNotification(this.rdest,b)},c.prototype._sendHangupCall=function(){var a;return this.state="sent-bye",a={dialogParams:this.params},this.client.rpc.call("verto.bye",a,function(){return function(){}}(this))},c.prototype.handleRpcCall=function(a,b){switch(a){case"verto.bye":return this._gotHangup(b);case"verto.invite":return this.params.callID=b.callID,this.params.caller_id_name=b.caller_id_name,this.params.caller_id_number=b.caller_id_number,this._gotRemoteOfferAnswer("offer",b);case"verto.answer":return this._gotRemoteOfferAnswer("answer",b),this.emit("answer")}},c.prototype._gotRemoteOfferAnswer=function(a,b){return this.state="got-"+a,b.type=a,null!=this.rtc?this.rtc.gotRemoteOfferAnswer(b):console.log("Error: RTC not inited")},c.prototype._gotHangup=function(){return this.state="got-bye",null!=this.rtc?(this.rtc.stop(),this.rtc=null,this.emit("end")):void 0},c}(bit6.EventEmitter)}.call(this),function(){window.bit6||(window.bit6={}),bit6.JsonRpc=function(){function a(a){var b;this.options=a,null==(b=this.options).sessid&&(b.sessid=bit6.JsonRpc.generateGUID()),this.currentId=1,this.callbacks={},this.queue=[],this.closed=!1}return a.prototype.reconnectDelay=2e3,a.prototype.connect=function(){return this.closed=!1,null==this.ws?(this.ws=new WebSocket(this.options.wsUrl),this.ws.onopen=function(a){return function(){var b,c,d,e;for(e=a.queue,c=0,d=e.length;d>c;c++)b=e[c],a.ws.send(b);return a.queue=[]}}(this),this.ws.onmessage=function(a){return function(b){var c,d,e;try{if(e=JSON.parse(b.data),(null!=e.result||null!=e.error)&&null!=e.id&&(c=a.callbacks[e.id],delete a.callbacks[e.id],c(e.error,e.result)),null!=e.method&&null!=e.params)return null!=e.id?a.options.onRpcCall(e.method,e.params,function(b,c){var d;return d={jsonrpc:"2.0",id:e.id},null!=b&&(d.error=b),null!=c&&(d.result=c),a._send(d)}):a.options.onRpcCall(e.method,e.params)}catch(f){return d=f,console.log("Exception parsing JSON response ",d),console.log("  -- RAW {{{",b.data,"}}}")}}}(this),this.ws.onclose=function(a){return function(){return a.closed?void 0:(a.ws=null,window.setTimeout(function(){return a.connect()},a.reconnectDelay))}}(this),this.ws.onerror=function(a){return function(){return console.log("Rpc ws got error. Socket state="+a.ws.readyState)}}(this)):void 0},a.prototype.notify=function(a,b){return this.call(a,b,!1)},a.prototype.call=function(a,b,c){var d;return null==this.ws&&this.connect(),d={jsonrpc:"2.0",method:a,params:b},d.params.login=this.options.login,d.params.passwd=this.options.password,null!=this.options.sessid&&(d.params.sessid=this.options.sessid),c!==!1&&(d.id=this.currentId++,this.callbacks[d.id]=c),this._send(d)},a.prototype._send=function(a){var b;return b=JSON.stringify(a),null!=this.ws&&1===this.ws.readyState?this.ws.send(b):this.queue.push(b)},a.prototype.close=function(){return this.closed=!0,null!=this.ws&&this.ws.close(),this.ws=null},a.generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=16*Math.random()|0,c="x"===a?b:3&b|8,c.toString(16)})},a}()}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b},c=[].slice;window.bit6||(window.bit6={}),bit6.Client=function(a){function d(a){var b;if(this.options=a,d.__super__.constructor.apply(this,arguments),null==this.options.apikey)throw'Missing required "apikey" option';this.apikey=this.options.apikey,this.env=null!=(b=this.options.env)?b:"prod",this._clear(),this.session=new bit6.Session(this)}var e;return b(d,a),e={prod:"https://api.bit6.com",dev:"https://api.b6dev.net",local:"http://127.0.0.1:3000"},d.prototype._clear=function(){return this.me=null,this.conversations=null,this.dialogs=[]},d.prototype._onLogin=function(a){return this._connectRt(),this.loadMe(function(){return function(){return a(null)}}(this))},d.prototype._onLogout=function(a){return this._disconnectRt(),this._clear(),null!=a?a(null):void 0},d.prototype.loadMe=function(a){var b;return b={embed:"messages,identities,devices,groups",since:0},this.api("/me",b,function(b){return function(c,d){return c?a(c):(b.me=d,b.buildConversations(a))}}(this))},d.prototype.buildConversations=function(a){var b,c,d,e,f,g,h,i,j,k;if(e={},!this.me||!this.me.messages)return a(null);for(k=this.me.messages,i=0,j=k.length;j>i;i++)h=k[i],h.deleted||(g=0===h.me.indexOf("grp:")?h.me:h.other,d=e[g],d||(d={uri:g,updated:0,messages:[]}),h.updated>d.updated&&(d.updated=h.updated),d.messages.push(h),e[g]=d);b=[];for(f in e)c=e[f],b.push(c);return b.sort(function(a,b){return b.updated-a.updated}),this.conversations=b,a(null)},d.prototype.getConversationByUri=function(a){var b,c,d,e;for(e=this.conversations,c=0,d=e.length;d>c;c++)if(b=e[c],b.uri===a)return b;return null},d.prototype.addEmptyConversation=function(a){var b,c,d,e,f;for(f=this.conversations,d=0,e=f.length;e>d;d++)if(b=f[d],b.uri===a)return void this.emit("messages");return c={uri:a,updated:Date.now(),messages:[]},this.conversations.unshift(c),this.emit("messages")},d.prototype.removeConversation=function(a,b){var c,d,e,f,g,h,i,j,k;for(i=this.conversations,k=[],e=0,g=i.length;g>e;e++)if(c=i[e],c.uri===a){for(j=c.messages,f=0,h=j.length;h>f;f++)d=j[f],this.removeMessage(d.id);k.push(b())}else k.push(void 0);return k},d.prototype.removeMessage=function(a,b){return this.api("/me/messages/"+a,"DELETE",function(a,c){return"function"==typeof b?a?b(a):b(null,c):void 0})},d.prototype.sendMessage=function(a,b){return this.api("/me/messages","POST",a,function(a){return function(c,d){return c?b(c):a.loadMe(function(){return a.emit("messages"),b(null,d)})}}(this))},d.prototype.getGroupById=function(a){var b,c,d,e;if(null==this.me.groups)return null;for(0===a.indexOf("grp:")&&(a=a.substring(4)),e=this.me.groups,c=0,d=e.length;d>c;c++)if(b=e[c],a===b.id)return b;return null},d.prototype.getNameFromIdentity=function(a){var b,c,d;if(d=a,c=a.split(":"),2!==c.length)return d;switch(c[0]){case"usr":d=c[1];break;case"grp":b=this.getGroupById(a),b&&(d=b.group.title)}return d},d.prototype.sendTypingNotification=function(a){return this._sendNotification(a,"typing")},d.prototype.sendNotification=function(a,b,c){return(null!=b?b.length:void 0)<1||"_"===b.charAt(0)?!1:this._sendNotification(a,"_"+b,c)},d.prototype._sendNotification=function(a,b,c){var d,e;return e={type:b,from:this.session.identity},null!=c&&(e.data=c),d={to:a,body:JSON.stringify(e)},this.rpc.call("verto.info",{msg:d},function(){return function(){}}(this)),!0},d.prototype.startCall=function(a,b){return this._createDialog(!0,a,b)},d.prototype._createDialog=function(a,b,c){var d;return d=this.findDialogByOther(b),null!=d?d:(d=new bit6.Dialog(this,a,b,c),this.dialogs.push(d),d.on("error",function(){return function(){return console.log("Dialog error: ",d)}}(this)),d.on("end",function(a){return function(){return a.deleteDialog(d)}}(this)),d)},d.prototype.handleRtMessage=function(a){var b,c,d,e,f,g,h,i,j,k;switch(a.type){case"push":if(c=a.data,d=3840&c.flags,1280===d)return c.video=144===(144&c.flags),e={audio:!0,video:c.video},b=this._createDialog(!1,c.sender,e),b.rdest=c.rdest,this.emit("incomingCall",b);if(1536!==d)return 1792===d?console.log("accepted call from",c.sender,"rdest=",c.rdest):2048===d?console.log("rejected call from",c.sender,"rdest=",c.rdest):this.loadMe(function(b){return function(){return b.emit("messages",a.data)}}(this));if(console.log("missed call from",c.sender,"rdest=",c.rdest),b=this.findDialogByRdest(c.rdest),null!=b)return b.hangup();break;case"update":if(null!=(null!=(i=a.data)?i.messages:void 0)){for(j=a.data.messages,g=0,h=j.length;h>g;g++)f=j[g],this.updateMessage(f);return this.emit("messages")}break;case"typing":return this.emit("notification",a);default:if((null!=a&&null!=(k=a.type)?k.length:void 0)>1&&"_"===a.type.charAt(0))return a.type=a.type.substring(1),this.emit("notification",a)}},d.prototype.updateMessage=function(a){var b,c,d,e,f,g,h,i,j;if(null!=a.id)for(i=this.me.messages,e=0,g=i.length;g>e;e++)if(c=i[e],c.id===a.id){if(a.flags&&(c.flags=a.flags),null!=c.others&&null!=a.others)for(j=c.others,b=f=0,h=j.length;h>f;b=++f)d=j[b],c.others[b].status=a.others[b].status;return}},d.prototype.handleRpcNotify=function(){},d.prototype.handleRpcCall=function(a,b,c){var d,e,f,g,h;switch(a){case"verto.info":if(null!=(null!=b&&null!=(h=b.msg)?h.body:void 0))try{g=JSON.parse(b.msg.body),this.handleRtMessage(g)}catch(i){e=i,console.log("Exception parsing JSON response verto.info",e),console.log("  -- RAW {{{",b.msg.body,"}}}")}break;case"verto.bye":d=this.findDialogByCallID(b.callID),d&&d.handleRpcCall(a,b);break;case"verto.invite":f=b.caller_id_name,f&&(f=f.split("@")),d=this.findDialogByOther(b.caller_id_name),d&&d.handleRpcCall(a,b);break;case"verto.answer":d=this.findDialogByCallID(b.callID),d&&d.handleRpcCall(a,b)}return c(null,{method:a})},d.prototype._connectRt=function(){var a,b,c,d,e;return c=null!=(d=this.session.config)&&null!=(e=d.rtc)?e.vertoServers:void 0,c.length<1?void console.log("Error: no Verto servers"):(b=c[0],a={wsUrl:b.url,login:b.username,password:b.credential,onRpcCall:function(a){return function(b,c,d){return a.handleRpcCall(b,c,d)}}(this),onRpcNotify:function(a){return function(b,c){return a.handleRpcNotify(b,c)}}(this)},this.rpc=new bit6.JsonRpc(a),this.rpc.call("login",{},function(){return function(){}}(this)))},d.prototype._disconnectRt=function(){return this.rpc?(this.rpc.close(),this.rpc=null):void 0},d.prototype.findDialogByCallID=function(a){var b,c,d,e,f;for(e=this.dialogs,c=0,d=e.length;d>c;c++)if(b=e[c],(null!=(f=b.params)?f.callID:void 0)===a)return b;return null},d.prototype.findDialogByOther=function(a){var b,c,d,e;for(e=this.dialogs,c=0,d=e.length;d>c;c++)if(b=e[c],b.other===a)return b;return null},d.prototype.findDialogByRdest=function(a){var b,c,d,e;for(e=this.dialogs,c=0,d=e.length;d>c;c++)if(b=e[c],b.rdest===a)return b;return null},d.prototype.deleteDialog=function(a){var b,c,d,e,f;for(f=this.dialogs,c=d=0,e=f.length;e>d;c=++d)if(b=f[c],b===a)return void this.dialogs.splice(c,1)},d.prototype.api=function(){var a,b,d,e;return d=arguments[0],b=3<=arguments.length?c.call(arguments,1,e=arguments.length-1):(e=1,[]),a=arguments[e++],this._api.apply(this,["/app/1"+d].concat(c.call(b),[a]))},d.prototype._api=function(){var a,b,d,f,g,h,i,j,k,l,m;return i=arguments[0],h=3<=arguments.length?c.call(arguments,1,m=arguments.length-1):(m=1,[]),b=arguments[m++],1===h.length?("string"==typeof h[0]&&(g=h[0]),"object"==typeof h[0]&&(d=h[0])):h.length>=2&&(g=h[0],d=h[1]),null==g&&(g="get"),null==d&&(d={}),g=g.toLowerCase(),k=e[this.env]+i,k+=i.indexOf("?")<0?"?":"&",k+="apikey="+this.apikey,"post"!==g&&(k+="&_method="+g),this.session.token&&(d._auth="bearer "+this.session.token),a=function(){var a;a=[];for(f in d)a.push(encodeURIComponent(f)+"="+encodeURIComponent(d[f]));return a}(),j=a.join("&"),l=new window.XMLHttpRequest,l.open("POST",k,!0),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(j),l.onload=function(){return function(){var a,c;c=null;try{c=JSON.parse(l.response)}catch(d){return a=d,b({status:501,message:"Cannot parse response",data:l.response})}return l.status>=200&&l.status<300?b(null,c):b(c,null)}}(this)},d.normalizeIdentityUri=function(a){var b,c,d,e,f;if(e=a.indexOf(":"),0>e)return null;switch(c=a.substr(0,e),c=c.trim().toLowerCase(),f=a.substr(e+1),b=d=null,c){case"grp":b=/[\s]/,d=/[0-9a-zA-Z._]{22}/;break;case"tel":b=/[^\\d+]/,d=/^\+[1-9]{1}[0-9]{8,15}$/;break;case"uid":f=f.toLowerCase(),b=/[^0-9a-f-]/,d=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;break;case"usr":f=f.toLowerCase(),b=/[^a-z0-9.]/,d=/^[a-z0-9.]+$/;break;default:return null}return b&&(f=f.replace(b,"")),f.search(d)<0?null:c+":"+f},d}(bit6.EventEmitter)}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};window.bit6||(window.bit6={}),bit6.Rtc=function(a){function c(a){this.dialog=a,c.__super__.constructor.apply(this,arguments),this.pcConstraints={optional:[{DtlsSrtpKeyAgreement:!0}]},this.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},this.isStarted=!1,this.remoteStream=null,this.localStream=null,this.pc=null,this.bufferedIceCandidates=[],this.bufferedIceCandidatesDone=!1,this.bufferedOfferAnswer=null}return b(c,a),c.prototype.start=function(a,b){return this.options=a,console.log("Rtc start",this.options),this.pcConfig=this.createPcConfig(this.options.iceServers),window.getUserMedia(this.options,function(a){return function(c){return a.handleUserMedia(c),b(!0)}}(this),function(){return function(a){return console.log("getUserMedia error: ",a),b(!1)}}(this))},c.prototype.stop=function(){return this.isStarted=!1,this.localStream&&(this.localStream.stop(),this.localStream=null),this.remoteStream&&(this.remoteStream=null),null!=this.options.localMediaEl&&(this.options.localMediaEl.src=""),null!=this.options.remoteMediaEl&&(this.options.remoteMediaEl.src=""),this.pc?(this.pc.close(),this.pc=null):void 0},c.prototype.handleUserMedia=function(a){return this.localStream=a,null!=this.options.localMediaEl&&(this.options.localMediaEl=window.attachMediaStream(this.options.localMediaEl,a)),this.dialog.outgoing?this.maybeStart():void 0},c.prototype.maybeStart=function(){return this.isStarted||null==this.localStream||(this.pc=this.createPeerConnection(),null==this.pc)?void 0:(this.pc.addStream(this.localStream),this.isStarted=!0,this.dialog.outgoing?this.pc.createOffer(function(a){return function(b){return a.setLocalAndSendOfferAnswer(b)}}(this),function(){return function(a){return console.log("CreateOffer error",a)}}(this)):void 0)},c.prototype.createPeerConnection=function(){var a;try{return this.pc=new window.RTCPeerConnection(this.pcConfig,this.pcConstraints),this.pc.onicecandidate=function(a){return function(b){return a.handleIceCandidate(b)}}(this),this.pc.onaddstream=function(a){return function(b){return a.handleRemoteStreamAdded(b)}}(this),this.pc.onremovestream=function(a){return function(b){return a.handleRemoteStreamRemoved(b)}}(this),this.pc}catch(b){return a=b,console.log("Failed to create PeerConnection, exception: ",a),null}},c.prototype.handleIceCandidate=function(a){var b,c,d;return null!=a.candidate?(b=a.candidate,c=b.sdpMLineIndex,null==(d=this.bufferedIceCandidates)[c]&&(d[c]=[]),this.bufferedIceCandidates[c].push(b)):(this.bufferedIceCandidatesDone=!0,this.maybeSendOfferAnswer())},c.prototype.maybeSendOfferAnswer=function(){var a;return this.bufferedOfferAnswer&&this.bufferedIceCandidatesDone&&(a=this._mergeSdp(this.bufferedOfferAnswer,this.bufferedIceCandidates),this.bufferedOfferAnswer=null,this.bufferedIceCandidates=[],this.bufferedIceCandidatesDone=!1,a)?this.emit("offerAnswer",a):void 0},c.prototype._mergeSdp=function(a,b){var c,d,e,f,g,h,i,j;for(g=a.sdp,d=[],h=0;(e=g.indexOf("m=",h+1))>=0;)d.push(g.substring(h,e)),h=e;for(d.push(g.substring(h)),g="",f=i=0,j=d.length;j>i;f=++i)c=d[f],g+=c,f>0&&null!=b[f-1]&&(g+=this._iceCandidatesToSdp(b[f-1]));return a.sdp=g,a},c.prototype._iceCandidatesToSdp=function(a){var b,c,d,e;for(c="",d=0,e=a.length;e>d;d++)b=a[d],c+="a="+b.candidate+"\r\n";return c},c.prototype.handleRemoteStreamAdded=function(a){return this.remoteStream=a.stream,null!=this.options.remoteMediaEl?this.options.remoteMediaEl=window.attachMediaStream(this.options.remoteMediaEl,a.stream):void 0},c.prototype.handleRemoteStreamRemoved=function(a){return console.log("Remote stream removed:",a)},c.prototype.setLocalAndSendOfferAnswer=function(a){return this.pc.setLocalDescription(a,function(b){return function(){return b.bufferedOfferAnswer={type:a.type,sdp:a.sdp},b.maybeSendOfferAnswer()}}(this))},c.prototype.gotRemoteOfferAnswer=function(a){var b;switch(b=new window.RTCSessionDescription(a),a.type){case"offer":return this.dialog.outgoing||this.isStarted||this.maybeStart(),this.pc.setRemoteDescription(b),this.pc.createAnswer(function(a){return function(b){return a.setLocalAndSendOfferAnswer(b)}}(this),function(){return function(a){return console.log("CreateAnswer error",a)}}(this));case"answer":if(this.isStarted)return this.pc.setRemoteDescription(b)}},c.prototype.gotHangup=function(){return this.stop()},c.prototype.createPcConfig=function(a){var b;return console.log("RTC createPcConfig got ICE servers:",a),b={iceServers:a}},c}(bit6.EventEmitter)}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b},c=[].slice;window.bit6||(window.bit6={}),bit6.Session=function(a){function d(a){this.client=a,d.__super__.constructor.apply(this,arguments),this._clear()}return b(d,a),d.prototype._clear=function(){return this.authenticated=!1,this.authInfo=null,this.config=null,this.identity=null,this.token=null,this.userid=null},d.prototype.logout=function(a){return this._clear(),this.client._onLogout(a)},d.prototype.login=function(a,b){return a.identity=bit6.Client.normalizeIdentityUri(a.identity),this._auth("login",a,b)},d.prototype.signup=function(a,b){return a.identity=bit6.Client.normalizeIdentityUri(a.identity),this._auth("signup",a,b)},d.prototype.anonymous=function(a){return this._auth("anonymous",{},a)},d.prototype.oauth=function(a,b,c){var d,e;return d=null!=(e=b.redirect_uri)?e:b.redirectUri,null==d&&(b.redirect_uri=window.location.href.split("?")[0]),this.getAuthInfo(function(d){return function(e){return e?c(e):(b.client_id=d.authInfo[a].client_id,d._auth(a,b,c))}}(this))},d.prototype.getAuthInfo=function(a){return this.authInfo?a(null,this.authInfo):this.api("/info",function(b){return function(c,d){return c?a(c):(b.authInfo=d,a(c,d))}}(this))},d.prototype._auth=function(a,b,c){return null==b&&(b={}),null==b.device&&(b.device="web-"+bit6.JsonRpc.generateGUID()),b.embed="config",this.api("/"+a,"POST",b,function(a){return function(b,d){return b?c(b):a._authDone(d,c)}}(this))},d.prototype._authDone=function(a,b){var c,d,e,f,g;if(null==a.token)return b("Jwt token is missing");for(this.authenticated=!0,f=["config","identity","token","userid"],d=0,e=f.length;e>d;d++)c=f[d],this[c]=null!=(g=a[c])?g:null;return this.client._onLogin(b)},d.prototype.api=function(){var a,b,d,e,f;return d=arguments[0],b=3<=arguments.length?c.call(arguments,1,e=arguments.length-1):(e=1,[]),a=arguments[e++],(f=this.client)._api.apply(f,["/auth/1"+d].concat(c.call(b),[a]))},d}(bit6.EventEmitter)}.call(this);var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia){console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10);var RTCPeerConnection=function(a,b){return maybeFixConfiguration(a),new mozRTCPeerConnection(a,b)};RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn"))if(27>webrtcDetectedVersion){var f=a.split("?");(1===f.length||0===f[1].indexOf("transport=udp"))&&(d={url:f[0],credential:c,username:b})}else d={url:a,credential:c,username:b};return d},createIceServers=function(a,b,c){var d=[];for(i=0;i<a.length;i++){var e=createIceServer(a[i],b,c);null!==e&&d.push(e)}return d},attachMediaStream=function(a,b){return console.log("Attaching media stream"),a.mozSrcObject=b,a.play(),a},reattachMediaStream=function(a,b){return console.log("Reattaching media stream"),a.mozSrcObject=b.mozSrcObject,a.play(),a},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})}else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),createIceServer=function(a,b,c){var d=null,e=a.split(":");return 0===e[0].indexOf("stun")?d={url:a}:0===e[0].indexOf("turn")&&(d={url:a,credential:c,username:b}),d},createIceServers=function(a,b,c){var d=[];if(webrtcDetectedVersion>=34)d={urls:a,credential:c,username:b};else for(i=0;i<a.length;i++){var e=createIceServer(a[i],b,c);null!==e&&d.push(e)}return d};var RTCPeerConnection=function(a,b){return 34>webrtcDetectedVersion&&maybeFixConfiguration(a),new webkitRTCPeerConnection(a,b)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(a,b){return"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element."),a},reattachMediaStream=function(a,b){return a.src=b.src,a}}else console.log("Browser does not appear to be WebRTC-capable");